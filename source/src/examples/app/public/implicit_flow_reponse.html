<!DOCTYPE HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>OIDC Authentication Response Validator Example</title>

  <!-- include source files here... -->
  <script type="text/javascript" src="src/assets/lib/jsrsasign/js/jsrsasign-4.7.0-all-min.js"></script>
  <script type="text/javascript" src="src/assets/lib/jsjws/js/json-sans-eval.js"></script>
  <script type="text/javascript" src="src/assets/lib/jsjws/js/jws-3.0.js"></script>
  <script type="text/javascript" src="src/assets/lib/jquery/js/jquery.min.js"></script>
  
  <script type="text/javascript" src="src/assets/lib/jsjws.patch.js"></script>
  <script type="text/javascript" src="src/assets/oAuthClient.js"></script>
  <script type="text/javascript" src="src/assets/OIDCAuthenticationResponseValidator.js"></script>
  <script type="text/javascript" src="src/assets/promise-6.0.0.js"></script>
</head>

<body>
    
    <script>
        <!--//
        
        //Redirect to login on vouch.
        $(function(){
            
            OIDCDiscoveryFactory("https://saserver1/vouch")
            .then(JKWSCertificateFactory)
            .then(OAuthClientFactory)
            .then(function(client){
                      
                //Make sure we have a record of the request sent to the Authorization Server
				if (typeof localStorage['OAuthRequestDetails'] !== 'undefined') {
					try {
						var request = JSON.parse(localStorage['OAuthRequestDetails']);
					} catch(e) {
						var request = null;
					}
				}
				
				try {
					var rV = new OIDCAuthentication.ResponseValidator(request, location.hash);
					var valid = rV.validate(client.oidc.client_certificate);
				} catch(e) {
					localStorage.removeItem('OAuthRequestDetails'); // Clear the stored data out (stops replay attacks)
				
					//Did validation fail because of missing parameters
					if (e instanceof OIDCAuthentication.ResponseValidator.Error) {
						//There was no request so we never made a request before...
						if (e.name == "MissingParameterError") {
							var req = client.createImplicitFlowRequest(
								"ssp",
								"http://" + location.hostname + ":" + location.port + "/implicit_flow_reponse.html",
								'openid profile ssp', 'id_token token');
							localStorage['OAuthRequestDetails'] = JSON.stringify(req);
							window.location = req.url;	
						}
						
						if (e.parameter == "response") {
							console.log(e.stack);	
						}
					}
					
					console.log(e);
				}
				
				if (valid) {
					var p = $("<p>").text("It went well");
				} else {
					var p = $("<p>").text("It went wrong");
				}
				
				$("body").append(p);
				
            }).catch(function(e){
				var p = $("<p>").text("It went wrong");
				$("body").append(p);
			});
        });
		//-->
    </script>
    
</body>
</html>